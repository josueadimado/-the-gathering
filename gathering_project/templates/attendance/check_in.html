{% extends 'base.html' %}
{% load static %}

{% block title %}Check In - The Gathering{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.css" rel="stylesheet">
<style>
    #qr-reader {
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: #f8f9fa;
    }
    
    #qr-reader-results {
        min-height: 50px;
    }
    
    .qr-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 0.75rem;
        border-radius: 4px;
        margin-top: 0.5rem;
    }
    
    .qr-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 0.75rem;
        border-radius: 4px;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block page_title %}Check In{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Check In People</h4>
            </div>
            <div class="card-body">
                <form method="post" id="checkInForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.event.id_for_label }}" class="form-label">Select Event *</label>
                        {{ form.event }}
                        {% if form.event.errors %}
                            <div class="text-danger small">{{ form.event.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.person.id_for_label }}" class="form-label">Search Person *</label>
                        <input type="text" 
                               id="personSearch" 
                               class="form-control" 
                               placeholder="Type name or phone number..."
                               autocomplete="off">
                        <div id="searchResults" class="list-group mt-2" style="display: none;"></div>
                        {{ form.person }}
                        {% if form.person.errors %}
                            <div class="text-danger small">{{ form.person.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes (Optional)</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="text-danger small">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Check In
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'attendance:list' %}" class="btn btn-outline-info">
                        <i class="bi bi-list-check"></i> View All Attendance
                    </a>
                    <a href="{% url 'people:list' %}" class="btn btn-outline-primary">
                        <i class="bi bi-people"></i> View People
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-qr-code-scan"></i> QR Code Scanner</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="qrEventSelect" class="form-label small">Select Event for QR Check-In:</label>
                    <select id="qrEventSelect" class="form-select form-select-sm">
                        <option value="">Choose an event...</option>
                        {% for event in upcoming_events %}
                        <option value="{{ event.pk }}">{{ event.name }} - {{ event.event_date|date:"M d, Y" }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="qr-reader" style="width: 100%; min-height: 250px;"></div>
                <div id="qr-reader-results" class="mt-2"></div>
                
                <div class="text-center mt-3">
                    <button id="startScanner" class="btn btn-sm btn-success">
                        <i class="bi bi-camera"></i> Start Scanner
                    </button>
                    <button id="stopScanner" class="btn btn-sm btn-danger" style="display: none;">
                        <i class="bi bi-stop-circle"></i> Stop Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Person search functionality
document.getElementById('personSearch').addEventListener('input', function(e) {
    const query = e.target.value;
    const resultsDiv = document.getElementById('searchResults');
    const personInput = document.getElementById('{{ form.person.id_for_label }}');
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    fetch(`{% url 'attendance:search_person' %}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.results.length > 0) {
                resultsDiv.innerHTML = '';
                data.results.forEach(person => {
                    const item = document.createElement('a');
                    item.className = 'list-group-item list-group-item-action';
                    item.href = '#';
                    item.innerHTML = `<strong>${person.name}</strong><br><small class="text-muted">${person.phone}</small>`;
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        personInput.value = person.id;
                        document.getElementById('personSearch').value = person.name;
                        resultsDiv.style.display = 'none';
                    });
                    resultsDiv.appendChild(item);
                });
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.style.display = 'none';
            }
        });
});

// Hide results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#personSearch') && !e.target.closest('#searchResults')) {
        document.getElementById('searchResults').style.display = 'none';
    }
});

// QR Code Scanner functionality
let html5QrcodeScanner = null;
const startBtn = document.getElementById('startScanner');
const stopBtn = document.getElementById('stopScanner');
const qrEventSelect = document.getElementById('qrEventSelect');
const qrResultsDiv = document.getElementById('qr-reader-results');

startBtn.addEventListener('click', function() {
    const eventId = qrEventSelect.value;
    if (!eventId) {
        alert('Please select an event first');
        return;
    }
    
    startQRScanner(eventId);
});

stopBtn.addEventListener('click', function() {
    stopQRScanner();
});

function startQRScanner(eventId) {
    if (html5QrcodeScanner) {
        return; // Already started
    }
    
    html5QrcodeScanner = new Html5Qrcode("qr-reader");
    
    html5QrcodeScanner.start(
        { facingMode: "environment" }, // Use back camera
        {
            fps: 10,
            qrbox: { width: 250, height: 250 }
        },
        (decodedText, decodedResult) => {
            // Successfully scanned QR code
            handleQRCodeScanned(decodedText, eventId);
        },
        (errorMessage) => {
            // Ignore scanning errors (they're frequent during scanning)
        }
    ).then(() => {
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        qrResultsDiv.innerHTML = '<p class="text-muted small">Scanning... Point camera at QR code</p>';
    }).catch((err) => {
        console.error("Unable to start scanning", err);
        qrResultsDiv.innerHTML = `<div class="qr-error">Error: ${err.message}</div>`;
    });
}

function stopQRScanner() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
            html5QrcodeScanner.clear();
            html5QrcodeScanner = null;
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            qrResultsDiv.innerHTML = '';
        }).catch((err) => {
            console.error("Error stopping scanner", err);
        });
    }
}

function handleQRCodeScanned(qrCodeData, eventId) {
    // Stop scanning after successful scan
    stopQRScanner();
    
    // Extract person ID from QR code (assuming QR code contains person UUID)
    const personId = qrCodeData.trim();
    
    // Show loading message
    qrResultsDiv.innerHTML = '<p class="text-muted small">Processing check-in...</p>';
    
    // Send check-in request
    const formData = new FormData();
    formData.append('person_id', personId);
    formData.append('event_id', eventId);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "attendance:check_in_qr" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            qrResultsDiv.innerHTML = `<div class="qr-success"><i class="bi bi-check-circle"></i> ${data.message}</div>`;
            // Reload page after 2 seconds to refresh the form
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            qrResultsDiv.innerHTML = `<div class="qr-error"><i class="bi bi-exclamation-circle"></i> ${data.message}</div>`;
            // Allow scanning again after error
            setTimeout(() => {
                startQRScanner(eventId);
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        qrResultsDiv.innerHTML = `<div class="qr-error">Error processing check-in. Please try again.</div>`;
        setTimeout(() => {
            startQRScanner(eventId);
        }, 3000);
    });
}

// Clean up scanner when page is unloaded
window.addEventListener('beforeunload', function() {
    if (html5QrcodeScanner) {
        stopQRScanner();
    }
});
</script>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}

